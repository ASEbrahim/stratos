# STATE.md — StratOS Project State

> Living document. Updated at the end of every Claude Code session.
> Loaded into Claude.ai Project Knowledge and Claude Code context.
> **CLAUDE.md** = how to work here. **STATE.md** = what happened and why. **FRS** = what the system should be.

Last updated: **2026-02-27** (session: diagnostic bug fixes — 5 fixes, 6 commits)

---

## 1. Current State

### What's Deployed

- **Server:** `python3 main.py --serve --background` on port 8080
- **Active profile:** Ahmad — Petroleum Engineering Professor at Kuwait University / Seisnetics consultant
- **Context hash:** `8e86611559e6` (role + context + location → SHA-256 12-char)
- **Scorer model:** `stratos-scorer-v2` (8.7GB Q8_0, DoRA fine-tuned Qwen3-8B)
- **Inference model:** `qwen3:30b-a3b` (~18-19GB MoE) — strat agent + market analysis only
- **Wizard/briefing model:** `qwen3:14b` (~9GB) — wizard, briefings, profile generation, suggestions
- **Search provider:** Serper (Google) primary, DuckDuckGo fallback. 60-min dedup window on Serper queries.
- **Serper credits:** ~1524 remaining of 2500 (key: `1b9db98...` in `.env`) — 365 used total (228 Phase 1 + 82 Phase 2 + 55 post-fix validation)

### V2 Scorer Production Metrics

| Metric | V1 | V2 (Production) |
|--------|-----|-----------------|
| Direction accuracy | 90.7% | **98.1%** |
| MAE | 1.553 | **0.393** (75% reduction) |
| Spearman ρ | — | **0.750** |
| Profile awareness spread | 1.04 | **7.90** (7.6× improvement) |
| Parse failures | — | 0 |

### Scan Pipeline Performance

| Metric | Value |
|--------|-------|
| Full scan (cold) | ~5 min (scoring ~450s + fetch ~30s, briefing async) |
| Incremental scan | ~60s (scores reused, 0 LLM calls) |
| Briefing | 14-30s, non-blocking (background thread via 14b) |
| Articles per scan | ~100-148 |
| Scoring speed | ~3.3s/article |
| Output stability | Stable at 97-100 across incremental scans |

### Last Scan Output

- 100 articles, 3 retained, 8 categories populated
- Categories: oiltech (43), kuniv (34), confer (10), career (6), govpol (3), cybersec (2), cloudai (1), certev (1)
- Sources: Serper/Google (85), LinkedIn (6), Web Search (4), Instagram (3), Kuwait News (1), Twitter/X (1)
- Briefing: present (deferred, generated by 14b)

### Data Sources

| Source | Status | Notes |
|--------|--------|-------|
| Serper/Google | Active, ~2220 credits | Primary search. 60-min dedup window. `max_results: 10` per query. |
| DuckDuckGo | Active, fallback | Fires when Serper dedup blocks or credits exhausted. Poor on regional/GCC queries. |
| RSS | 0 feeds configured | Available but unused for current profile. |
| Kuwait Intelligence | Active | Dedicated fetcher for Kuwait-specific sources via Serper + DDG fallback. |
| yfinance | Active | Market data, cached aggressively. ~5s fetch. |

### What's Working

- Full scan pipeline: fetch → score → defer briefing → output
- Incremental scanning: reuses scores from snapshot, carries forward unfetched articles
- Profile-scoped retention: context hash tags, filtered by active role
- Deferred briefing: scan completes immediately, briefing patches output async via SSE `briefing_ready`
- Model routing: 14b handles briefings (14-30s), 30b reserved for agent chat
- Two-pass scoring: fast timeout Pass 1, 3x slower Pass 2 for deferred items
- Serper + DDG dual provider with automatic fallback
- Fullscreen chart: drawing tools (trend, ray, fib, rect, etc.) with drag/resize, anchor-aware endpoint editing, canvas clipping, keyboard shortcuts (Delete, Escape, Ctrl+Z)
- Focus mode: rounded corners, enlarged TF buttons near ticker, bottom intel panel (analysis + Strat Market agent)

### What's Broken / Needs Attention

- ~~**CRITICAL — Retention cross-profile leak:**~~ **FIXED** (commit a0f9c47). All output articles now tagged with `retained_by_profile: context_hash`. Filter works correctly.
- ~~**MODERATE — Extra feeds not in scan pipeline:**~~ **FIXED** (commit b6cdfdd). Opt-in via `scoring.include_extra_feeds_in_scan: true` in config.yaml. Default off — zero behavior change until enabled.
- ~~**MODERATE — Deferred briefing uncapturable:**~~ **FIXED** (commit 59a4a0c). `wait_for_briefing(timeout=30)` method added with generation counter for race safety.
- **kuniv category over-scoring:** Articles mentioning "Kuwait" get scored high regardless of topical relevance to the active profile. "Embassy of India, Kuwait" scored 9.0 for a petroleum engineering professor. Scorer training issue, not pipeline bug.
- **Frontend SSE for briefing_ready:** Backend broadcasts `briefing_ready` event, but frontend doesn't listen for it yet — briefing appears on next data poll, not instantly.
- **FRS v9 and README v8 are stale:** Don't reflect model routing changes (14b briefing), deferred briefing, incremental scanning, or profile-scoped retention.
- **API key rotation pending:** Old Serper key (`ec4d2...`) and Google API key (`AIzaSy...`) were exposed in public git history (scrubbed with git-filter-repo). Should be rotated.

### What's Not Yet Done

- **Cross-profile re-scoring** (Phase 2 from retention spec): when switching profiles, re-score other profiles' retained articles against the new context
- **Intelligence Archive** (Phase 3): dedicated searchable archive of all retained signals across all profiles
- **VRAM coexistence test:** scorer (8.7GB) + 14b (~9GB) may fit in 24GB simultaneously — haven't tested `OLLAMA_MAX_LOADED_MODELS=2` yet
- **RSS feeds:** currently empty (`rss_feeds: []`), all news comes from search queries

### GitHub

- **Portfolio:** [asebrahim.github.io](https://github.com/ASEbrahim/ASEbrahim.github.io) — Live at https://asebrahim.github.io
- **Codebase:** [github.com/ASEbrahim/stratos](https://github.com/ASEbrahim/stratos) — Public. API keys scrubbed from history.
- **API keys:** In `backend/.env` (gitignored). `config.yaml` uses `${VAR}` placeholders.

---

## 2. Decision Log

> Append-only. Newest first. Each entry: WHAT was decided, WHY, and WHAT was rejected.

### 2026-02-27

**D012 — Canvas pointer-events: none, events on chartEl**
Drawing canvas overlay with `pointer-events: auto` blocked all chart interactions (scroll, zoom, pan). Moved all mouse/touch event listeners from the canvas to the underlying `chartEl` div. Canvas stays permanently `pointer-events: none`. During active drag, chart interaction disabled via `handleScroll: false` / `handleScale: false`, re-enabled on drag end.
*Rejected:* Toggling `pointer-events` dynamically (fragile, caused stuck state after tool use).

**D013 — Anchor-aware drawing drag (start/end/body)**
`_fsAnchorHitTest()` checks proximity (16px radius) to start and end anchors vs line body. Grabbing an anchor rotates/resizes the drawing from that end; grabbing the body translates the whole shape. This matches TradingView behavior.
*Rejected:* Body-only drag (user couldn't rotate or resize), separate resize handles (overengineered for canvas drawings).

**D014 — Crosshair as toggle, not cursor-mode tool**
Crosshair button toggles `CrosshairMode.Normal` ↔ `CrosshairMode.Hidden` independently of the active tool. Stored as `_fs.crosshairOn` boolean.
*Rejected:* Treating crosshair as a cursor mode (conflicted with drawing tools, always re-enabled on tool switch).

**D015 — Bottom intel panel inside cfs-chart-area flex column**
Intel panel placed inside `.cfs-chart-area` (flex column) after `.cfs-chart-container` (flex: 1). Chart shrinks naturally to accommodate panel expansion. Grip handle with drag-to-resize (28px collapsed, up to 50vh). Height persisted in localStorage.
*Rejected:* Overlay/modal (blocks chart), separate panel outside chart area (layout complexity).

**D016 — Separate agent chat state for focus mode**
Focus mode agent uses its own `_cfsAgentHistory` and `_cfsAgentAppend`, independent from the markets panel `_mpAgentHistory`. Prevents cross-contamination between the two chat contexts. Each auto-injects current ticker context into messages.
*Rejected:* Sharing state with markets panel agent (confusing when switching between views).

**D017 — _fsSaveDrawings triggers analysis refresh**
Instead of adding `_fsRenderAnalysis()` at every individual drawing completion/deletion/drag site, hooked it into `_fsSaveDrawings()` which is called on every drawing mutation. Single call site, no missed cases.

**D018 — Tag all output articles with context_hash (not just retained)**
`_build_output()` now writes `retained_by_profile: context_hash` on every article unconditionally. Previously only retained articles got the tag, causing the filter in `_merge_retained_articles()` to let all non-retained articles through (BUG-1).
*Rejected:* Changing the filter logic to `if not article_profile: continue` (would break incremental scanning on first-ever scan with no snapshot).

**D019 — Generation counter for briefing thread race condition**
If scan B starts while scan A's briefing thread is still running, thread A's `_briefing_done.set()` could prematurely signal scan B's `wait_for_briefing()`. Added `_briefing_generation` counter — thread only signals if its generation matches current. `finally` block covers all exit paths.
*Rejected:* Simple `_briefing_done` Event without generation guard (race condition with concurrent scans).

**D020 — Route generic-keyword career matches to DoRA model at score 5.5**
When ALL matched keywords are in `GENERIC_KEYWORDS` (e.g., "water", "service") AND location doesn't match, return `(5.5, reason, False)` instead of `(9.0, reason, True)`. Score 5.5 avoids the Forbidden 5.0 nudge zone (4.8-5.2) and routes to the DoRA V2 model via `confident=False`. The model has geographic awareness from training.
*Rejected:* Hardcoded LOW_WEIGHT_KEYWORDS word list that caps at 7.0 (user pointed out DoRA model should handle this). Also rejected 5.0 as placeholder (collides with Forbidden 5.0 Rule).

**D021 — Remove cross-entity combination queries**
Cross-entity queries like `"E1" "E2" deal OR partnership 2026` returned 0 results ~30% of the time across 16 diagnostic profiles. Removed the entire block from `_build_dynamic_searches()`. Saves ~30% Serper credits per category.
*Rejected:* Keeping but reducing pairs (still wastes credits on overly specific queries).

**D022 — Add "Brighter" theme variant (8 themes × 3 modes = 24 variants)**
Added `[data-bright="true"]` CSS blocks for all 8 themes. Lifts backgrounds +8-12 lightness, pushes text toward white, bumps accents one tier, increases border visibility. For readability on dimmed OLED screens. 3-position toggle cycles: Normal → Deeper → Brighter. Starry themes get boosted star opacity. `data-bright` and `data-dark` are mutually exclusive. Backward-compatible: existing "Deeper" users auto-migrate via `stratos-dark` → `stratos-theme-mode` localStorage key.

### 2026-02-26

**D001 — Carry forward unfetched snapshot articles in incremental scan**
Initial incremental scan only reused scores for re-fetched URLs. Articles not re-fetched (Serper dedup skipped the query) were dropped, shrinking output 100 → 21. Fix: carry forward all snapshot articles not in the fresh fetch set. Retained articles excluded (handled separately by `_merge_retained_articles`).

**D002 — In-memory snapshot for incremental scoring, not database**
Original spec proposed `scored_at` column + per-URL DB lookups. Used existing `_snapshot_previous_articles()` instead: zero migrations, zero DB changes, purely in-memory URL→score lookup. Trade-off: doesn't persist state independently (relies on output JSON file), but that file survives server restarts.
*Rejected:* Database-backed dedup (requires migration, more complex), ETag/Last-Modified on RSS (helps RSS only).

**D003 — Deferred briefing as background thread**
Python `threading.Thread(daemon=True)` is simpler than asyncio for a single background task. Briefing thread patches output JSON (atomic enough for single-user). Multi-user would need a lock.
*Rejected:* Async/await (overengineered for this), synchronous blocking (2-5min wait for users).

**D004 — Briefings on wizard_model (14b), not inference_model (30b)**
Briefings are summaries, not agent reasoning. 14b produces adequate briefings in 14-30s vs 2-5min for 30b. Real win: scorer (8.7GB) + 14b (~9GB) = ~18GB, may coexist in 24GB VRAM without swapping. Reused existing `wizard_model` config key rather than adding `briefing_model`.
*Rejected:* Keeping 30b for everything (swap penalty too high), adding separate `briefing_model` config key (unnecessary).

**D005 — Context hash (role+context+location) over profile name for retention**
A single profile can have multiple roles. SHA-256 of normalized `role|context|location` captures the full intelligence context. Normalization (lowercase, collapse whitespace) prevents hash changes from trivial edits. 12-char hex prefix is sufficient. Column name stays `retained_by_profile` (stores hash, renaming is churn).
*Rejected:* Profile name only (doesn't handle role switches), role-only hash (misses context/location).

**D006 — `retained_by_profile` in output JSON, not database**
Retention is an output-layer concern: articles tagged during `_merge_retained_articles()`, persisted through JSON output cycle. No schema migration needed.

**D007 — Serper key exhaustion was the real bug, not just env loading**
Initial diagnosis: `_load_env_secrets()` not called after config reload. This was a real code bug (fixed), but the actual reason was old Serper key had zero credits server-side despite local tracker showing 202. Confirmed with direct curl. New key resolved it.

### Pre-Feb 26

**D008 — Q8_0 quantization for scorer**
Fine-tuned models are more sensitive to quantization — learned LoRA weight deltas are small and get disproportionately compressed. Q4_K_M introduced noticeable scoring errors. Q8_0 preserves near-lossless quality at 8.7GB.
*Rejected:* Q4_K_M (quality loss), Q6_K (acceptable but unnecessary given VRAM headroom).

**D009 — 30b MoE over dense 14b for inference**
`qwen3:30b-a3b` achieves 80.4% AIME 2024 vs ~55% for 14b, 0.97 F1 on tool calling. Actually faster than dense 14b (~34 t/s vs ~32 t/s) because only 3.3B params active per token.
*Rejected:* 14b for everything (insufficient reasoning for agent tasks).

**D010 — CoT training over answer-only (v19 design)**
Answer-only training (v15-v18) proved insufficient — model memorized patterns but couldn't reason about profile-specific relevance. Research confirms: Orca showed imitation models learn style not reasoning; only explanation tuning transfers capability. DeepSeek-R1 distillation into 8B beat GPT-4o on AIME. Qwen3's native `<think>` blocks make this natural.
*Rejected:* Answer-only format (all of v15-v18 failed), external CoT pipeline (unnecessary with native think blocks).

**D011 — DoRA over standard LoRA**
DoRA offers 1-4% gains over LoRA with better tolerance for lower ranks. For scoring where small precision differences matter, worth the ~20% training overhead.
*Rejected:* Standard LoRA (marginally worse), full fine-tuning (won't fit in VRAM).

---

## 3. Failure Log

> Non-obvious failures that future sessions might repeat. If the natural instinct would be to try the same approach, log it here.

### 2026-02-27

**F009 — Canvas pointer-events: auto causes stuck chart**
After using any drawing tool, canvas kept `pointer-events: auto`, blocking all chart scroll/zoom/pan. User had to exit and re-enter focus mode.
**Rule:** Canvas overlays should always be `pointer-events: none`. Listen on the parent element and use coordinate math to detect canvas interactions.

**F010 — `document.getElementById()` fails on detached DOM elements**
Intel panel elements (agent send button, input) were created in a detached DOM tree (`chartWrap` not yet appended to `root`). `document.getElementById()` returned null, so event listeners were never attached. User could type but not send.
**Rule:** For elements in detached DOM, use `parentElement.querySelector()` instead of `document.getElementById()`.

**F011 — Qwen3 `think: false` leaks into hray anchor logic**
Initial hray anchor drag implementation incremented `startIdx` twice (once in generic code, once in hray-specific). Caused erratic movement.
**Rule:** When special-casing drawing types in shared drag logic, ensure the general path doesn't also execute.

### 2026-02-27

**F009 — Retention profile filter bypassed for freshly scored articles**
`_merge_retained_articles()` (main.py:1267-1268) checks `retained_by_profile` to filter cross-profile articles. But freshly scored articles in the output JSON have NO `retained_by_profile` field (only set on already-retained articles in `_build_output()` lines 1327-1329). Empty string is falsy → filter condition `if article_profile and ...` is False → article passes through. Result: up to 20 high-scoring articles from Profile N leak into Profile N+1 with original scores/reasons. Confirmed across all 16 diagnostic profiles (Phase 1 + Phase 2). Even fresh StratOS instances don't fix it because `output/news_data.json` persists between profiles.
**Rule:** Always write `retained_by_profile` with context hash on ALL output articles, or change filter: `if not article_profile or article_profile != context_hash: continue`.

**F012 — Extra feed toggles are UI-only, not wired into scan pipeline**
`extra_feeds_finance`/`extra_feeds_politics` settings control which curated RSS feeds (oilprice, bloomberg, bbc, etc.) appear in the Finance/Politics tabs. But `fetch_extra_feeds()` is only called from `server.py` on-demand API endpoints (`/api/finance-news`, `/api/politics-news`), never from `main.py:run_scan()`. Users enabling these toggles in settings expect those articles to be scored — they are not.
**Rule:** Either integrate `fetch_extra_feeds()` into `NewsFetcher.fetch_all()` or clearly document the separation.

**F013 — Forbidden 5.0 collision with LLM routing placeholder**
Original fix plan for S3 (generic keyword routing) used `score=5.0` as the LLM routing placeholder. But the Forbidden 5.0 Rule (6 locations in `scorer_adaptive.py`) nudges scores 4.8-5.2 away from 5.0. If the nudge ran before LLM evaluation, it would push the score to 4.8 (below the uncertain zone). If LLM failed, the article kept 5.0 — a score the system is designed to never produce.
**Rule:** Never use 5.0 as a deliberate placeholder score. Use 5.5 (safely inside the uncertain zone, outside the nudge range).

### 2026-02-26

**F001 — `_build_output()` whitelist drops unknown fields**
Output builder constructs each article dict from an explicit key list. New fields added in-memory (like `retained_by_profile`) get silently dropped unless added to the whitelist. Cost a full debug cycle. **Rule:** When adding article metadata, always check `_build_output()`.

**F002 — Incremental scan dropped unfetched articles**
`_reuse_snapshot_scores()` only carried forward articles the fetcher re-fetched AND matched the snapshot. Articles not re-fetched (Serper dedup blocked) vanished. Output: 100 → 21.
**Rule:** Incremental scan output must NEVER shrink (barring dismissals or profile changes).

**F003 — Serper env placeholder not expanded after config reload**
`config.yaml` stored `${SERPER_API_KEY}` as literal string. YAML doesn't expand env vars. `_load_env_secrets()` was called once during `__init__` but not after config reloads. Client received literal `${SERPER_API_KEY}`, got 401, silently fell back to DDG.
**Rule:** After config reload, re-initialize secrets AND verify downstream clients see updated values.

### Earlier

**F004 — AOTRITON causes NaN gradients on ROCm 6.2**
`TORCH_ROCM_AOTRITON_ENABLE_EXPERIMENTAL=1` causes NaN during backward pass with DoRA + gradient checkpointing + bf16 on 7900 XTX. Keep disabled for training. Safe for inference only.

**F005 — Answer-only training produces flat scorers (v15-v18)**
Models trained on `SCORE: X | REASON: Y` without reasoning traces converge to giving everything 8.0-8.5. Profile awareness: 1.04 (essentially random).
**Rule:** Always include `<think>` reasoning traces. V2 with CoT achieved 7.90 awareness (7.6×).

**F006 — Qwen3 `think: false` doesn't work**
Setting `think: False` in Ollama calls doesn't suppress thinking — model leaks reasoning as plain text, consuming entire `num_predict` budget.
**Rule:** Never set `think` parameter. Omit entirely. Strip `<think>...</think>` from output as safety net.

**F007 — SFTTrainer `assistant_only_loss=True` breaks with Qwen3**
Qwen3's default template lacks `{% generation %}` keyword required by TRL.
**Rule:** Use modified template or Unsloth/ms-swift for loss masking.

**F008 — Qwen3-8B 8-bit loading fails; 4-bit works**
**Rule:** Use 4-bit QLoRA for training (10-12GB VRAM). Use Q8_0 GGUF for inference (8.7GB).

**F-misc — Serper local tracker vs server-side credits can desync**
`SerperQueryTracker` counts queries locally, but Serper's server tracks independently. If the key is used elsewhere or credits are purchased, local count becomes wrong. Fix: trust API response over local tracking. `set_remaining()` exists but requires manual invocation.

**F-misc — PEFT meta device after `get_peft_model()`**
Must delete `hf_device_map` and force `.to("cuda:0")` or gradient computation crashes.

**F-misc — Training format must match inference exactly**
`export_training.py` must produce messages character-for-character identical to `scorer_adaptive.py` inference format. Any mismatch (extra whitespace, different system prompt) degrades model quality.

---

## 4. Session Log

> Most recent first. 3-5 lines per session.

### 2026-02-27 — Diagnostic Bug Fixes + Post-Fix Validation (5 fixes, 8 commits)
**Commits:** 8 (a0f9c47, 59a4a0c, 6463ad4, d5378f1, b6cdfdd, a76cb35, + validation + STATE.md)
Implemented all 5 fixes from the 16-profile diagnostic: (1) BUG-1 CRITICAL — tag all output articles with `retained_by_profile: context_hash` to prevent cross-profile retention leak, (2) BUG-2 — store briefing thread with generation counter + `wait_for_briefing()`, (3) S4 — remove cross-entity combination queries (~30% Serper credit savings), (4) S3 — route generic-keyword career matches to DoRA model at score 5.5 instead of hardcoded 9.0, (5) BUG-3 — opt-in extra feeds integration in scan pipeline (`scoring.include_extra_feeds_in_scan`). Each fix is an independent commit, rollback-safe via `git revert`. 54 tests pass after every commit.
**Post-fix validation:** Ran 3 adversarial profiles (P6 ElecTech, P7 PetroJourno, P10 CSUK) sequentially. **All 4 tests PASS:** zero cross-profile contamination (was 20→17→1 before), all articles tagged, `wait_for_briefing()` captures briefings reliably, generic-keyword articles routed to DoRA model (Firelands Electric → 1.0, Nebraska Exam Prep → 2.5, zero false positives ≥8.0). Serper: 55 credits used (1579→1524).

### 2026-02-27 — 16-Profile Pipeline Diagnostic Loop (Phase 1 + Phase 2)
**Commits:** 2 (diagnostic report + extended diagnostic)
**Phase 1** (10 profiles): Ran full diagnostic across 5 diverse (nurse/TX, quant/London, marine bio/Tokyo, cybersec/Dubai, teacher/São Paulo) + 5 adversarial near-miss to Ahmad (elec tech/Kuwait MEW, petro journalist/Kuwait Times, IT support/KOC, mech eng/SABIC/Saudi, CS student/KU). **Critical bug found:** retention system leaks up to 20 articles from previous profile (main.py:1267-1268). V2 scorer itself performs well on fresh articles. Serper: 1916→1688 (228 used).
**Phase 2** (6 profiles): Extended diagnostic targeting pipeline gaps. Profiles: energy analyst/Houston (RSS feeds enabled), gov relations/Kuwait (Arabic content), papyrologist/Oxford (ultra-niche), MechEng student/Saudi (student vs P9 senior), graphic designer/Lisbon (empty categories), CEO/Singapore (broad generalist). Key improvements: fresh StratOS instance per profile, 30s briefing wait. **Findings:** (1) BUG-1 confirmed even with fresh instances (output file persists between profiles), (2) **New BUG-3:** extra feed toggles don't affect scan pipeline (fetch_extra_feeds never called from run_scan), (3) Briefing capture 100% at 30s wait, (4) Student vs senior: zero shared articles, mean 3.16 vs ~6.5, (5) Empty categories handled gracefully, (6) Bimodal score distribution universal (medium band empty), (7) Cross-entity combo queries still ~30% waste. Serper: 1661→1579 (82 used). See `DIAGNOSTIC_FINDINGS.md` for consolidated report.

### 2026-02-27 — Focus Mode Polish & Drawing Tools Overhaul
**Commits:** 5 frontend (c48b82f → 9f1367b), 5 parent (a389779 → fc573ad)
Key work: (1) Draggable drawings with anchor-aware endpoint editing (rotate/resize from either end, translate from body). (2) Drawing tools UX overhaul: canvas clip rects prevent bleeding into price scale, right-click cancel, Delete/Backspace/Escape keyboard shortcuts, events moved from canvas to chartEl. (3) Crosshair toggle (on/off). (4) Ticker name enhancement (symbol + full name, improved dropdown). (5) Focus mode polish: TF buttons moved left and enlarged, rounded corners with 8px inset margin, draggable bottom intel panel with live analysis (momentum, volatility, S/R, range, fibonacci) and embedded Strat Market agent chat. (6) Bug fix: `getElementById` on detached DOM → `querySelector`.

### 2026-02-26 — Pipeline Optimizations + Retention System
**Commits:** 10 (9e42de4 → 39fc9a2)
Key work: (1) Portfolio site deployed at asebrahim.github.io, codebase pushed to github.com/ASEbrahim/stratos. (2) Security incident: API keys in public repo, scrubbed with git-filter-repo. Rotation pending. (3) Serper provider fix (env reload + new key). (4) Profile-scoped retention via context hash. (5) Model routing: 30b → agent only, 14b → briefings. (6) Deferred non-blocking briefing. (7) Incremental scanning with snapshot carry-forward. (8) STATE.md workflow established.

---

## 5. Hardware & Environment

| Component | Spec |
|-----------|------|
| CPU | AMD Ryzen 7 7800X3D |
| GPU (primary) | AMD Radeon 7900 XTX (24GB VRAM) |
| GPU (spare) | NVIDIA RTX 2070 Super 8GB (needs riser cable) |
| RAM | 32GB DDR5-6000 MT/s CL30 (dual-channel) |
| OS | Ubuntu 24 (dual-boot) |
| GPU Compute | AMD ROCm 6.2 |
| Python | 3.12 |
| Ollama | Local, `OLLAMA_MAX_LOADED_MODELS=1`, `OLLAMA_KEEP_ALIVE=10m` |

---

## 6. Training Data & Scorer History

| Version | Examples | Method | Cost | Key Metric | Outcome |
|---------|----------|--------|------|------------|---------|
| V1 (v15-v18) | 5,679 | Sonnet 4.6 distillation, answer-only | ~$17 | Awareness: 1.04 | Failed — flat scoring |
| V2 (v19) | 20,550 | Opus Batch API, CoT traces, 30 profiles, 20 countries | ~$52 | Awareness: 7.90, ρ: 0.750 | **Production** |
| V3 (planned) | ~30,000 | Merged V1+V2 + new pipeline data | TBD | TBD | Not started |

---

## 7. Profiles

| Name | Role | Hash |
|------|------|------|
| Ahmad | Petroleum Engineering Professor / Seisnetics Consultant | `8e86611559e6` |
| saa | (incomplete/test profile) | — |

Primary profile is Computer Engineering student at AUK (Ahmad's real profile). Petroleum professor is active for testing.

---

## 8. Key File Locations

| What | Where |
|------|-------|
| Main orchestrator | `backend/main.py` |
| Scorer | `backend/processors/scorer_adaptive.py` |
| Briefing generator | `backend/processors/briefing.py` |
| News fetcher | `backend/fetchers/news.py` |
| Kuwait intelligence | `backend/fetchers/kuwait_scrapers.py` |
| Serper client | `backend/fetchers/serper_search.py` |
| Database | `backend/database.py` |
| Auth/profiles | `backend/auth.py`, `backend/profiles/*.yaml` |
| Server/routes | `backend/server.py`, `backend/routes/` |
| Fullscreen chart & drawings | `frontend/mobile.js` (IIFE, all drawing tools + intel panel) |
| Markets panel & agent | `frontend/markets-panel.js` |
| Chart styles | `frontend/styles.css` (`.cfs-*` classes) |
| Output JSON | `backend/output/news_data.json` |
| API keys | `backend/.env` (gitignored) |
| Codebase guide | `backend/CLAUDE.md` |
| This file | `STATE.md` (repo root) |

---

## Maintenance

**Updating this file:**
- **Claude Code:** At session end, run "Update STATE.md with this session's changes"
- **Claude.ai:** Generate updated sections for manual commit or Project Knowledge upload
- **Decision Log:** Append-only. Never edit old entries.
- **Failure Log:** Curated. Only non-obvious failures worth preventing.
- **Session Log:** 3-5 lines per session, most recent first.
